#Main.ui
<?xml version="1.0" encoding="UTF-8"?>
<ui version="4.0">
 <class>MainForm</class>
 <widget class="QWidget" name="MainForm">
  <property name="geometry">
   <rect>
    <x>0</x>
    <y>0</y>
    <width>680</width>
    <height>374</height>
   </rect>
  </property>
  <layout class="QVBoxLayout" name="verticalLayout">
   <item>
    <widget class="QTabWidget" name="tabWidget">
     <property name="sizePolicy">
      <sizepolicy hsizetype="Expanding" vsizetype="Expanding">
       <horstretch>0</horstretch>
       <verstretch>0</verstretch>
      </sizepolicy>
     </property>
     <property name="currentIndex">
      <number>1</number>
     </property>
     <widget class="QWidget" name="tab">
      <attribute name="title">
       <string>–û–±–∑–æ—Ä</string>
      </attribute>
      <layout class="QVBoxLayout" name="tabLayout">
       <item>
        <layout class="QVBoxLayout" name="dashboardLayout"/>
       </item>
      </layout>
     </widget>
     <widget class="QWidget" name="tab_2">
      <attribute name="title">
       <string>–ü–∞—Ü–∏–µ–Ω—Ç—ã</string>
      </attribute>
      <layout class="QVBoxLayout" name="patientsLayout">
       <item>
        <layout class="QHBoxLayout" name="searchLayout">
         <item>
          <widget class="QLineEdit" name="searchNameEdit">
           <property name="placeholderText">
            <string>–§–ò–û</string>
           </property>
          </widget>
         </item>
         <item>
          <widget class="QLineEdit" name="searchIdEdit">
           <property name="placeholderText">
            <string>ID</string>
           </property>
          </widget>
         </item>
         <item>
          <widget class="QLineEdit" name="searchDiagEdit">
           <property name="placeholderText">
            <string>–î–∏–∞–≥–Ω–æ–∑</string>
           </property>
          </widget>
         </item>
        </layout>
       </item>
       <item>
        <layout class="QHBoxLayout" name="filterLayout">
         <item>
          <widget class="QComboBox" name="deptBox"/>
         </item>
         <item>
          <widget class="QComboBox" name="statusBox"/>
         </item>
         <item>
          <widget class="QComboBox" name="ageBox"/>
         </item>
        </layout>
       </item>
       <item>
        <widget class="QTableWidget" name="patientsTable"/>
       </item>
       <item>
        <widget class="QGroupBox" name="quickBox">
         <property name="title">
          <string>–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</string>
         </property>
         <layout class="QHBoxLayout">
          <item>
           <widget class="QPushButton" name="qaNewTreatmentBtn">
            <property name="text">
             <string>–ù–æ–≤–æ–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ</string>
            </property>
           </widget>
          </item>
          <item>
           <widget class="QPushButton" name="qaVisitBtn">
            <property name="text">
             <string>–ó–∞–ø–∏—Å–∞—Ç—å –Ω–∞ –ø—Ä–∏–µ–º</string>
            </property>
           </widget>
          </item>
          <item>
           <widget class="QPushButton" name="qaResearchBtn">
            <property name="text">
             <string>–î–æ–±–∞–≤–∏—Ç—å –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ</string>
            </property>
           </widget>
          </item>
          <item>
           <widget class="QPushButton" name="qaEpicrisisBtn">
            <property name="text">
             <string>–°–æ–∑–¥–∞—Ç—å —ç–ø–∏–∫—Ä–∏–∑</string>
            </property>
           </widget>
          </item>
         </layout>
        </widget>
       </item>
      </layout>
     </widget>
     <widget class="QWidget" name="tab_history">
      <attribute name="title">
       <string>–ò—Å—Ç–æ—Ä–∏—è –±–æ–ª–µ–∑–Ω–µ–π</string>
      </attribute>
      <layout class="QVBoxLayout">
       <item>
        <widget class="QTableWidget" name="historyTable"/>
       </item>
      </layout>
     </widget>
     <widget class="QWidget" name="tab_treatments">
      <attribute name="title">
       <string>–ù–∞–∑–Ω–∞—á–µ–Ω–∏—è</string>
      </attribute>
      <layout class="QVBoxLayout">
       <item>
        <widget class="QTableWidget" name="treatmentTable"/>
       </item>
      </layout>
     </widget>
     <widget class="QWidget" name="tab_research">
      <attribute name="title">
       <string>–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è</string>
      </attribute>
      <layout class="QVBoxLayout">
       <item>
        <widget class="QTableWidget" name="researchTable"/>
       </item>
      </layout>
     </widget>
    </widget>
   </item>
  </layout>
 </widget>
 <resources/>
 <connections/>
</ui>


#main.py
import sys, random, requests, subprocess
from PySide6.QtWidgets import (
    QApplication, QMainWindow, QTableWidgetItem, QMenu,
    QDialog, QVBoxLayout, QFormLayout, QLabel, QPushButton,
    QMessageBox, QAbstractItemView, QTreeWidget, QTreeWidgetItem, QWidget,QLineEdit, QTableWidget, QComboBox
)
from PySide6.QtWebEngineWidgets import QWebEngineView
from PySide6.QtUiTools import QUiLoader
from PySide6.QtCore import QFile, QTimer, QUrl, Qt
from PySide6.QtGui import QColor

API = "http://127.0.0.1:8000"

# ---------------- UI LOADER ----------------
def load_ui(name, parent=None):
    f = QFile(name)
    f.open(QFile.ReadOnly)
    ui = QUiLoader().load(f, parent)
    f.close()
    return ui

# ---------------- LOGIN ----------------
class Login(QMainWindow):
    def __init__(self):
        super().__init__()
        self.ui = load_ui("Login.ui", self)
        self.ui.loginBtn.clicked.connect(self.go)

    def go(self):
        r = requests.post(API+"/login", json={
            "mail": self.ui.mailEdit.text(),
            "password": self.ui.passEdit.text()
        })
        if r.status_code != 200:
            self.ui.statusLabel.setText("login fail")
            return
        token = r.json()["access_token"]
        self.v = Verify(token)
        self.v.show()
        self.close()

# ---------------- VERIFY ----------------
class Verify(QMainWindow):
    def __init__(self, token):
        super().__init__()
        self.ui = load_ui("Verify.ui", self)
        self.token = token
        self.sms_ok = False
        self.captcha_ok = False
        self.sms = str(random.randint(1000,9999))
        self.ui.smsLabel.setText(f"SMS –∫–æ–¥: {self.sms}")
        self.ui.smsBtn.clicked.connect(self.check_sms)
        self.ui.captchaLabel.setText(
            "–ü–∞—Ü–∏–µ–Ω—Ç 65 –ª–µ—Ç, –ê–î 170/100, –≥–ª—é–∫–æ–∑–∞ 8.5 ‚Äî –¥–∏–∞–≥–Ω–æ–∑?"
        )
        self.ui.captchaBtn.clicked.connect(self.check_captcha)

    def check_sms(self):
        if self.ui.smsEdit.text() == self.sms:
            self.sms_ok = True
            self.try_open_main()

    def check_captcha(self):
        if "–≥–∏–ø–µ—Ä" in self.ui.captchaEdit.text().lower():
            self.captcha_ok = True
            self.try_open_main()

    def try_open_main(self):
        if self.sms_ok and self.captcha_ok:
            me = requests.get(
                API+"/me",
                headers={"Authorization": f"Bearer {self.token}"}
            ).json()
            self.m = Main(self.token, me["role"])
            self.m.show()
            self.close()

# ---------------- HELPERS ----------------
def age_group(age):
    if age >= 60:
        return "–ü–æ–∂–∏–ª–æ–π"
    if age < 18:
        return "–†–µ–±—ë–Ω–æ–∫"
    return "–í–∑—Ä–æ—Å–ª—ã–π"

def risk_from_age(age):
    if age >= 65:
        return "high"
    if age >= 45:
        return "medium"
    return "low"

# ---------------- MAIN ----------------
class Main(QMainWindow):
    def __init__(self, token, role):
        super().__init__()
        self.ui = load_ui("Main.ui")
        self.setCentralWidget(self.ui)

        self.token = token
        self.role = role
        self.patients_data = []
        self.notifications = []

        # ---------- STREAMLIT ----------
        self.streamlit_process = subprocess.Popen(
            [
                "streamlit",
                "run",
                "dashboard.py",
                "--server.port",
                "8501",
                "--server.headless",
                "true"
            ],
            stdout=subprocess.DEVNULL,
            stderr=subprocess.DEVNULL
        )
        QTimer.singleShot(3000, self.init_webview)

        # ---------- PATIENT TAB ----------
        self.init_patients_tab()
        self.load_patients_from_api()
        self.init_quick_actions()

        # ---------- –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –í–ö–õ–ê–î–ö–ò ----------
        self.add_extra_tabs()
        self.add_journal_tab()
        self.add_recommendations_tab()

        # ---------- –†–û–õ–ï–í–û–ô –î–û–°–¢–£–ü ----------
        self.setup_role_permissions()

        # ---------- –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ----------
        self.setup_notifications()

    # ---------- STREAMLIT VIEW ----------
    def init_webview(self):
        self.web = QWebEngineView(self)
        self.web.setUrl(QUrl("http://localhost:8501/?page=overview"))
        self.ui.dashboardLayout.addWidget(self.web)

    # ---------- –ù–û–í–´–ï –í–ö–õ–ê–î–ö–ò ----------
    def add_journal_tab(self):
        self.journal_tab = QWidget()
        layout = QVBoxLayout(self.journal_tab)

        # –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏
        self.add_journal_btn = QPushButton("–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å")
        self.add_journal_btn.clicked.connect(self.show_add_journal_dialog)
        layout.addWidget(self.add_journal_btn)

        # –¢–∞–±–ª–∏—Ü–∞ –∂—É—Ä–Ω–∞–ª–∞
        self.journal_table = QTableWidget()
        self.journal_table.setColumnCount(4)
        self.journal_table.setHorizontalHeaderLabels(["–î–∞—Ç–∞", "–¢–∏–ø", "–û–ø–∏—Å–∞–Ω–∏–µ", "–ü–∞—Ü–∏–µ–Ω—Ç"])
        self.journal_table.setEditTriggers(QTableWidget.NoEditTriggers)
        layout.addWidget(self.journal_table)

        self.ui.tabWidget.addTab(self.journal_tab, "–ñ—É—Ä–Ω–∞–ª")
        self.load_journal()

    def show_add_journal_dialog(self):
        dialog = QDialog(self)
        dialog.setWindowTitle("–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å –≤ –∂—É—Ä–Ω–∞–ª")
        layout = QFormLayout(dialog)

        date_edit = QLineEdit()
        date_edit.setPlaceholderText("–ì–ì–ì–ì-–ú–ú-–î–î")
        type_edit = QLineEdit()
        type_edit.setPlaceholderText("–ü—Ä–∏—ë–º / –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ / ...")
        desc_edit = QLineEdit()
        desc_edit.setPlaceholderText("–û–ø–∏—Å–∞–Ω–∏–µ")
        patient_edit = QLineEdit()
        patient_edit.setPlaceholderText("–§–ò–û –ø–∞—Ü–∏–µ–Ω—Ç–∞")

        layout.addRow("–î–∞—Ç–∞:", date_edit)
        layout.addRow("–¢–∏–ø:", type_edit)
        layout.addRow("–û–ø–∏—Å–∞–Ω–∏–µ:", desc_edit)
        layout.addRow("–ü–∞—Ü–∏–µ–Ω—Ç:", patient_edit)

        buttons = QDialogButtonBox(QDialogButtonBox.Ok | QDialogButtonBox.Cancel)
        buttons.accepted.connect(dialog.accept)
        buttons.rejected.connect(dialog.reject)
        layout.addRow(buttons)

        if dialog.exec() == QDialog.Accepted:
            data = {
                "date": date_edit.text(),
                "type": type_edit.text(),
                "description": desc_edit.text(),
                "patient_name": patient_edit.text()
            }
            # –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            r = requests.post(
                f"{API}/journal",
                json=data,
                headers={"Authorization": f"Bearer {self.token}"}
            )
            if r.status_code == 200:
                new_entry = r.json()
                self.insert_journal_row(new_entry)
            else:
                QMessageBox.warning(self, "–û—à–∏–±–∫–∞", "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å")
        
    def insert_journal_row(self, entry):
        row = self.journal_table.rowCount()
        self.journal_table.insertRow(row)
        self.journal_table.setItem(row, 0, QTableWidgetItem(entry["date"]))
        self.journal_table.setItem(row, 1, QTableWidgetItem(entry["type"]))
        self.journal_table.setItem(row, 2, QTableWidgetItem(entry["description"]))
        self.journal_table.setItem(row, 3, QTableWidgetItem(entry["patient_name"]))

    def add_extra_tabs(self):
        # –í–∫–ª–∞–¥–∫–∞ –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
        self.vis_tab = QWidget()
        layout = QVBoxLayout(self.vis_tab)
        self.vis_webview = QWebEngineView()
        self.vis_webview.setUrl(QUrl("http://localhost:8501/?page=analytics"))
        layout.addWidget(self.vis_webview)
        self.ui.tabWidget.addTab(self.vis_tab, "–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è")

        # –í–∫–ª–∞–¥–∫–∞ –î–æ–∫—É–º–µ–Ω—Ç—ã
        self.doc_tab = QWidget()
        layout = QVBoxLayout(self.doc_tab)
        self.doc_table = QTableWidget()
        self.doc_table.setColumnCount(3)
        self.doc_table.setHorizontalHeaderLabels(["–ù–∞–∑–≤–∞–Ω–∏–µ", "–î–∞—Ç–∞", "–°—Å—ã–ª–∫–∞"])
        self.doc_table.setRowCount(2)
        self.doc_table.setItem(0, 0, QTableWidgetItem("–í—ã–ø–∏—Å–∫–∞"))
        self.doc_table.setItem(0, 1, QTableWidgetItem("2026-02-14"))
        self.doc_table.setItem(0, 2, QTableWidgetItem("–°–∫–∞—á–∞—Ç—å"))
        self.doc_table.setItem(1, 0, QTableWidgetItem("–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞"))
        self.doc_table.setItem(1, 1, QTableWidgetItem("2026-02-13"))
        self.doc_table.setItem(1, 2, QTableWidgetItem("–°–∫–∞—á–∞—Ç—å"))
        layout.addWidget(self.doc_table)
        self.ui.tabWidget.addTab(self.doc_tab, "–î–æ–∫—É–º–µ–Ω—Ç—ã")

    def add_journal_tab(self):
        self.journal_tab = QWidget()
        layout = QVBoxLayout(self.journal_tab)
        self.journal_table = QTableWidget()
        self.journal_table.setColumnCount(4)
        self.journal_table.setHorizontalHeaderLabels(["–î–∞—Ç–∞", "–¢–∏–ø", "–û–ø–∏—Å–∞–Ω–∏–µ", "–ü–∞—Ü–∏–µ–Ω—Ç"])
        layout.addWidget(self.journal_table)
        self.ui.tabWidget.addTab(self.journal_tab, "–ñ—É—Ä–Ω–∞–ª")
        self.load_journal()

    def add_recommendations_tab(self):
        self.rec_tab = QWidget()
        layout = QVBoxLayout(self.rec_tab)
        self.rec_tree = QTreeWidget()
        self.rec_tree.setHeaderLabel("–ö–ª–∏–Ω–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏")
        for cat in ["–ì–∏–ø–µ—Ä—Ç–æ–Ω–∏—è", "–î–∏–∞–±–µ—Ç", "–ò–ë–°"]:
            item = QTreeWidgetItem([cat])
            r = requests.get(f"{API}/recommendations", params={"diagnosis": cat})
            if r.status_code == 200:
                recs = r.json()
                if isinstance(recs, list):
                    for rec in recs:
                        child = QTreeWidgetItem([rec])
                        item.addChild(child)
            self.rec_tree.addTopLevelItem(item)
        layout.addWidget(self.rec_tree)
        self.ui.tabWidget.addTab(self.rec_tab, "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏")

    def load_journal(self):
        r = requests.get(f"{API}/journal", headers={"Authorization": f"Bearer {self.token}"})
        if r.status_code == 200:
            data = r.json()
            self.journal_table.setRowCount(0)
            for entry in data:
                self.insert_journal_row(entry)

    # ---------- PATIENTS TAB ----------
    def init_patients_tab(self):
        ui = self.ui
        ui.patientsTable.setColumnCount(7)  # –¥–æ–±–∞–≤–∏–ª–∏ –∫–æ–ª–æ–Ω–∫—É –¥–ª—è —Ç–µ–≥–æ–≤
        ui.patientsTable.setHorizontalHeaderLabels(
            ["ID","–§–ò–û","–î–∏–∞–≥–Ω–æ–∑","–û—Ç–¥–µ–ª–µ–Ω–∏–µ","–°—Ç–∞—Ç—É—Å","–í–æ–∑—Ä–∞—Å—Ç","–¢–µ–≥–∏"]
        )

        ui.deptBox.addItems(["–í—Å–µ"])
        ui.statusBox.addItems(["–í—Å–µ"])
        ui.ageBox.addItems(["–í—Å–µ","–†–µ–±—ë–Ω–æ–∫","–í–∑—Ä–æ—Å–ª—ã–π","–ü–æ–∂–∏–ª–æ–π"])

        # –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ —Ç–µ–≥–∞–º
        ui.tagBox = QComboBox()
        ui.tagBox.addItems(["–í—Å–µ", "–î–∏–∞–±–µ—Ç", "–ì–∏–ø–µ—Ä—Ç–æ–Ω–∏—è", "–ë–µ—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å", "–°–µ—Ä–¥–µ—á–Ω–æ-—Å–æ—Å—É–¥–∏—Å—Ç—ã–µ"])
        ui.filterLayout.addWidget(ui.tagBox)
        ui.tagBox.currentTextChanged.connect(self.apply_filters)

        for w in [ui.searchNameEdit, ui.searchIdEdit, ui.searchDiagEdit]:
            w.textChanged.connect(self.apply_filters)

        ui.deptBox.currentTextChanged.connect(self.apply_filters)
        ui.statusBox.currentTextChanged.connect(self.apply_filters)
        ui.ageBox.currentTextChanged.connect(self.apply_filters)

        ui.patientsTable.setContextMenuPolicy(Qt.CustomContextMenu)
        ui.patientsTable.customContextMenuRequested.connect(self.patient_menu)
        ui.patientsTable.setSelectionMode(QAbstractItemView.MultiSelection)  # –≥—Ä—É–ø–ø–æ–≤–æ–π –≤—ã–±–æ—Ä

    def init_quick_actions(self):
        ui = self.ui
        ui.qaNewTreatmentBtn.clicked.connect(self.qa_new_treatment)
        ui.qaVisitBtn.clicked.connect(self.qa_visit)
        ui.qaResearchBtn.clicked.connect(self.qa_research)
        ui.qaEpicrisisBtn.clicked.connect(self.qa_epicrisis)

        # –ö–Ω–æ–ø–∫–∞ –≥—Ä—É–ø–ø–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
        ui.qaGroupBtn = QPushButton("–ì—Ä—É–ø–ø–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏")
        ui.qaGroupBtn.clicked.connect(self.group_operations)
        ui.quickBox.layout().addWidget(ui.qaGroupBtn)

        # –ö–Ω–æ–ø–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        ui.notifBtn = QPushButton("–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (0)")
        ui.notifBtn.clicked.connect(self.show_notification_center)
        ui.quickBox.layout().addWidget(ui.notifBtn)

    def setup_role_permissions(self):
        if self.role != 2:  # –Ω–µ –∞–¥–º–∏–Ω
            self.ui.quickBox.setVisible(False)

    # ---------- LOAD FROM API ----------
    def load_patients_from_api(self):
        if self.role != 2:
            return
        r = requests.get(
            API+"/patients",
            headers={"Authorization": f"Bearer {self.token}"}
        )
        if r.status_code != 200:
            return
        data = r.json()["patients"]
        self.patients_data = []
        for p in data:
            self.patients_data.append({
                "id": p["id"],
                "name": f'{p["second_name"]} {p["first_name"]} {p["patronomyc"]}',
                "diag": "‚Äî",
                "dept": "‚Äî",
                "status": "‚Äî",
                "age": p["age"],
                "risk": risk_from_age(p["age"]),
                "tags": p.get("tags", "")
            })
        self.apply_filters()

    # ---------- FILTER ----------
    def apply_filters(self):
        ui = self.ui
        rows = []
        tag_filter = ui.tagBox.currentText()
        for p in self.patients_data:
            if ui.searchNameEdit.text().lower() not in p["name"].lower():
                continue
            if ui.searchIdEdit.text() and ui.searchIdEdit.text() != str(p["id"]):
                continue
            if ui.searchDiagEdit.text().lower() not in p["diag"].lower():
                continue
            ag = age_group(p["age"])
            if ui.ageBox.currentText() != "–í—Å–µ" and ag != ui.ageBox.currentText():
                continue
            if tag_filter != "–í—Å–µ" and tag_filter not in p["tags"]:
                continue
            rows.append(p)
        self.fill_table(rows)

    # ---------- TABLE ----------
    def fill_table(self, data):
        t = self.ui.patientsTable
        t.setRowCount(len(data))
        colors = {
            "high": QColor("#ffb3b3"),
            "medium": QColor("#ffe0b3"),
            "low": QColor("#b3ffcc")
        }
        for r, p in enumerate(data):
            vals = [p["id"], p["name"], p["diag"], p["dept"], p["status"], p["age"], p["tags"]]
            for c, val in enumerate(vals):
                item = QTableWidgetItem(str(val))
                item.setBackground(colors[p["risk"]])
                t.setItem(r, c, item)
        t.resizeColumnsToContents()

    # ---------- CONTEXT MENU ----------
    def patient_menu(self, pos):
        table = self.ui.patientsTable
        row = table.currentRow()
        if row < 0:
            return
        pid = int(table.item(row,0).text())
        menu = QMenu()
        a_hist = menu.addAction("–ò—Å—Ç–æ—Ä–∏—è –±–æ–ª–µ–∑–Ω–µ–π")
        a_treat = menu.addAction("–ù–∞–∑–Ω–∞—á–µ–Ω–∏—è")
        a_res = menu.addAction("–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è")
        menu.addSeparator()
        tags_menu = menu.addMenu("–ù–∞–∑–Ω–∞—á–∏—Ç—å —Ç–µ–≥")
        for tag in ["–î–∏–∞–±–µ—Ç", "–ì–∏–ø–µ—Ä—Ç–æ–Ω–∏—è", "–ë–µ—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å", "–°–µ—Ä–¥–µ—á–Ω–æ-—Å–æ—Å—É–¥–∏—Å—Ç—ã–µ"]:
            action = tags_menu.addAction(tag)
            action.triggered.connect(lambda checked, t=tag: self.assign_tag(pid, t))
        act = menu.exec(table.mapToGlobal(pos))
        if act == a_hist:
            self.open_patient_tab(pid, "history")
        elif act == a_treat:
            self.open_patient_tab(pid, "treat")
        elif act == a_res:
            self.open_patient_tab(pid, "research")

    def assign_tag(self, pid, tag):
        requests.patch(
            f"{API}/patients/{pid}/tags",
            params={"tag": tag},
            headers={"Authorization": f"Bearer {self.token}"}
        )
        for p in self.patients_data:
            if p["id"] == pid:
                p["tags"] = tag
                break
        self.apply_filters()

    # ---------- GROUP OPERATIONS ----------
    def group_operations(self):
        selected_rows = set()
        for item in self.ui.patientsTable.selectedItems():
            selected_rows.add(item.row())
        if not selected_rows:
            QMessageBox.information(self, "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è", "–ù–µ –≤—ã–±—Ä–∞–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ –ø–∞—Ü–∏–µ–Ω—Ç–∞")
            return
        patient_ids = [int(self.ui.patientsTable.item(row, 0).text()) for row in selected_rows]
        dialog = QDialog(self)
        dialog.setWindowTitle("–ì—Ä—É–ø–ø–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏")
        layout = QVBoxLayout(dialog)
        layout.addWidget(QLabel("–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–≥ –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è:"))
        combo = QComboBox()
        combo.addItems(["–î–∏–∞–±–µ—Ç", "–ì–∏–ø–µ—Ä—Ç–æ–Ω–∏—è", "–ë–µ—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å", "–°–µ—Ä–¥–µ—á–Ω–æ-—Å–æ—Å—É–¥–∏—Å—Ç—ã–µ"])
        layout.addWidget(combo)
        btn = QPushButton("–ü—Ä–∏–º–µ–Ω–∏—Ç—å")
        layout.addWidget(btn)
        btn.clicked.connect(lambda: self.apply_bulk_tag(patient_ids, combo.currentText(), dialog))
        dialog.exec()

    def apply_bulk_tag(self, patient_ids, tag, dialog):
        requests.post(
            f"{API}/patients/bulk/tags",
            json={"patient_ids": patient_ids, "tag": tag},
            headers={"Authorization": f"Bearer {self.token}"}
        )
        for p in self.patients_data:
            if p["id"] in patient_ids:
                p["tags"] = tag
        self.apply_filters()
        dialog.accept()

    # ---------- DRUG INTERACTION (DIALOG) ----------
    def qa_new_treatment(self):
        pid = self.get_selected_patient_id()
        if not pid:
            return
        dialog = QDialog(self)
        dialog.setWindowTitle("–ù–æ–≤–æ–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ")
        layout = QVBoxLayout(dialog)
        layout.addWidget(QLabel(f"–ü–∞—Ü–∏–µ–Ω—Ç ID: {pid}"))
        form = QFormLayout()
        self.drug1_edit = QLineEdit()
        self.drug2_edit = QLineEdit()
        form.addRow("–ü—Ä–µ–ø–∞—Ä–∞—Ç 1:", self.drug1_edit)
        form.addRow("–ü—Ä–µ–ø–∞—Ä–∞—Ç 2:", self.drug2_edit)
        layout.addLayout(form)
        check_btn = QPushButton("–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ")
        layout.addWidget(check_btn)
        result_label = QLabel("")
        layout.addWidget(result_label)
        check_btn.clicked.connect(lambda: self.check_interaction(result_label))
        save_btn = QPushButton("–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ")
        layout.addWidget(save_btn)
        save_btn.clicked.connect(dialog.accept)
        dialog.exec()

    def check_interaction(self, label):
        drug1 = self.drug1_edit.text().strip()
        drug2 = self.drug2_edit.text().strip()
        if not drug1 or not drug2:
            label.setText("–í–≤–µ–¥–∏—Ç–µ –æ–±–∞ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞")
            return
        r = requests.get(f"{API}/drug-interaction", params={"drug1": drug1, "drug2": drug2})
        if r.status_code == 200:
            data = r.json()
            if data["interaction"]:
                label.setText(f"–í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ: {data['interaction']} (severity: {data['severity']})")
            else:
                label.setText("–í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ")
        else:
            label.setText("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏")

    # ---------- NOTIFICATIONS ----------
    def setup_notifications(self):
        self.notification_timer = QTimer()
        self.notification_timer.timeout.connect(self.check_notifications)
        self.notification_timer.start(30000)  # –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫
        self.check_notifications()

    def check_notifications(self):
        r = requests.get(f"{API}/notifications", headers={"Authorization": f"Bearer {self.token}"})
        if r.status_code == 200:
            data = r.json()
            self.notifications = data.get("notifications", [])
            self.ui.notifBtn.setText(f"–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ({len(self.notifications)})")
            for n in self.notifications:
                if n.get("priority") == "high":
                    self.show_notification_popup(n["message"])

    def show_notification_popup(self, message):
        # –ü—Ä–æ—Å—Ç–æ–µ –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ –æ–∫–Ω–æ
        msg = QMessageBox(self)
        msg.setIcon(QMessageBox.Critical)
        msg.setWindowTitle("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ")
        msg.setText(message)
        msg.setStandardButtons(QMessageBox.Ok)
        msg.show()

    def show_notification_center(self):
        dialog = QDialog(self)
        dialog.setWindowTitle("–¶–µ–Ω—Ç—Ä —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π")
        layout = QVBoxLayout(dialog)
        tree = QTreeWidget()
        tree.setHeaderLabel("–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è")
        groups = {"high": "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ", "medium": "–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è", "low": "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ"}
        for priority, title in groups.items():
            group_item = QTreeWidgetItem([title])
            for n in self.notifications:
                if n.get("priority") == priority:
                    item = QTreeWidgetItem([n["message"]])
                    group_item.addChild(item)
            tree.addTopLevelItem(group_item)
        layout.addWidget(tree)
        dialog.exec()

    # ---------- FAST ACTIONS (–∑–∞–≥–ª—É—à–∫–∏) ----------
    def get_selected_patient_id(self):
        t = self.ui.patientsTable
        row = t.currentRow()
        if row < 0:
            print("–ü–∞—Ü–∏–µ–Ω—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω")
            return None
        return int(t.item(row,0).text())

    def qa_visit(self):
        pid = self.get_selected_patient_id()
        if not pid: return
        print("–ø—Ä–∏–µ–º –¥–ª—è", pid)

    def qa_epicrisis(self):
        pid = self.get_selected_patient_id()
        if not pid: return
        print("—ç–ø–∏–∫—Ä–∏–∑ –¥–ª—è", pid)

    def qa_research(self):
        pid = self.get_selected_patient_id()
        if not pid: return
        print("–∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ")

    # ---------- OPEN PATIENT TAB (–∑–∞–≥–ª—É—à–∫–∏) ----------
    def open_patient_tab(self, pid, mode):
        r = requests.get(
            API + "/medical-card",
            params={"patient_id": pid},
            headers={"Authorization": f"Bearer {self.token}"}
        )
        if r.status_code != 200:
            print("medical-card error", r.text)
            return
        data = r.json()
        if mode == "research":
            self.fill_research(data["research"])
            self.ui.tabWidget.setCurrentWidget(self.ui.tab_research)
        elif mode == "treat":
            self.fill_treatments([])
            self.ui.tabWidget.setCurrentWidget(self.ui.tab_treatments)
        elif mode == "history":
            self.fill_history([])
            self.ui.tabWidget.setCurrentWidget(self.ui.tab_history)

    def fill_history(self, items):
        t = self.ui.historyTable
        t.setColumnCount(1)
        t.setHorizontalHeaderLabels(["–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö"])
        t.setRowCount(0)

    def fill_treatments(self, items):
        t = self.ui.treatmentTable
        t.setColumnCount(1)
        t.setHorizontalHeaderLabels(["–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö"])
        t.setRowCount(0)

    def fill_research(self, items):
        t = self.ui.researchTable
        t.setColumnCount(4)
        t.setHorizontalHeaderLabels(["ID","–ù–∞–∑–≤–∞–Ω–∏–µ","–î–∞—Ç–∞","–†–µ–∑—É–ª—å—Ç–∞—Ç"])
        t.setRowCount(len(items))
        for r,x in enumerate(items):
            t.setItem(r,0,QTableWidgetItem(str(x["id"])))
            t.setItem(r,1,QTableWidgetItem(x["name"]))
            t.setItem(r,2,QTableWidgetItem(str(x["date"])))
            t.setItem(r,3,QTableWidgetItem(str(x["result"])))
        t.resizeColumnsToContents()

    # ---------- CLOSE ----------
    def closeEvent(self, event):
        if hasattr(self, "streamlit_process"):
            self.streamlit_process.terminate()
        event.accept()

# ---------------- RUN ----------------
if __name__ == "__main__":
    app = QApplication(sys.argv)
    if "--test" in sys.argv:
        token = "test_token"
        role = 2
        w = Main(token, role)
    else:
        w = Login()
    w.show()
    app.exec()

#dashboard.py
import streamlit as st
import pandas as pd
import numpy as np
import plotly.express as px

st.set_page_config(layout="wide")

page = st.query_params.get("page", "overview")

if page == "overview":
    st.title("–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –¥–∞—à–±–æ—Ä–¥")

    st.subheader("üìà –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ª–µ—á–µ–Ω–∏—è")
    days = pd.date_range("2026-01-01", periods=14)
    treatment_df = pd.DataFrame({
        "–î–∞—Ç–∞": days,
        "–°—Ä–µ–¥–Ω–µ–µ –¥–∞–≤–ª–µ–Ω–∏–µ": np.linspace(165, 130, 14) + np.random.randint(-3, 3, 14),
        "–ì–ª—é–∫–æ–∑–∞": np.linspace(9.2, 6.1, 14) + np.random.normal(0, 0.2, 14),
        "CRP": np.linspace(18, 5, 14) + np.random.normal(0, 1, 14),
    })
    col1, col2, col3 = st.columns(3)
    col1.metric("–ê–î —Ç–µ–∫—É—â–µ–µ", "132", "-33")
    col2.metric("–ì–ª—é–∫–æ–∑–∞", "6.3", "-2.9")
    col3.metric("CRP", "6", "-12")
    fig = px.line(treatment_df, x="–î–∞—Ç–∞", y=["–°—Ä–µ–¥–Ω–µ–µ –¥–∞–≤–ª–µ–Ω–∏–µ", "–ì–ª—é–∫–æ–∑–∞", "CRP"],
                  title="–î–∏–Ω–∞–º–∏–∫–∞ –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π")
    st.plotly_chart(fig, use_container_width=True)

    st.subheader("üß¨ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–π")
    disease_df = pd.DataFrame({
        "–ù–æ–∑–æ–ª–æ–≥–∏—è": ["–ì–∏–ø–µ—Ä—Ç–æ–Ω–∏—è", "–°–î 2 —Ç–∏–ø–∞", "–ò–ë–°", "–û–†–í–ò", "–ë—Ä–æ–Ω—Ö–∏—Ç", "–ê—Å—Ç–º–∞"],
        "–ü–∞—Ü–∏–µ–Ω—Ç–æ–≤": [120, 85, 64, 210, 43, 27]
    })
    col1, col2 = st.columns(2)
    with col1:
        fig = px.pie(disease_df, names="–ù–æ–∑–æ–ª–æ–≥–∏—è", values="–ü–∞—Ü–∏–µ–Ω—Ç–æ–≤", title="–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤")
        st.plotly_chart(fig, use_container_width=True)
    with col2:
        fig = px.bar(disease_df, x="–ù–æ–∑–æ–ª–æ–≥–∏—è", y="–ü–∞—Ü–∏–µ–Ω—Ç–æ–≤", title="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª—É—á–∞–µ–≤")
        st.plotly_chart(fig, use_container_width=True)

    st.subheader("ü©∫ –†–∞–±–æ—á–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞")
    work_df = pd.DataFrame({
        "–î–µ–Ω—å": ["–ü–Ω", "–í—Ç", "–°—Ä", "–ß—Ç", "–ü—Ç", "–°–±"],
        "–ü—Ä–∏–µ–º–æ–≤": [28, 34, 31, 40, 37, 18],
        "–ü–µ—Ä–≤–∏—á–Ω—ã—Ö": [10, 12, 11, 15, 13, 6],
        "–ü–æ–≤—Ç–æ—Ä–Ω—ã—Ö": [18, 22, 20, 25, 24, 12],
    })
    col1, col2, col3 = st.columns(3)
    col1.metric("–í—Å–µ–≥–æ –ø—Ä–∏–µ–º–æ–≤", sum(work_df["–ü—Ä–∏–µ–º–æ–≤"]))
    col2.metric("–°—Ä–µ–¥–Ω–µ–µ/–¥–µ–Ω—å", round(work_df["–ü—Ä–∏–µ–º–æ–≤"].mean(), 1))
    col3.metric("–ú–∞–∫—Å–∏–º—É–º", max(work_df["–ü—Ä–∏–µ–º–æ–≤"]))
    fig = px.bar(work_df, x="–î–µ–Ω—å", y=["–ü–µ—Ä–≤–∏—á–Ω—ã—Ö", "–ü–æ–≤—Ç–æ—Ä–Ω—ã—Ö"],
                 title="–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–∏–µ–º–æ–≤ –ø–æ –¥–Ω—è–º", barmode="stack")
    st.plotly_chart(fig, use_container_width=True)

elif page == "analytics":
    st.title("–ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—Ç—á–µ—Ç—ã –ø–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ª–µ—á–µ–Ω–∏—è")

    st.subheader("–î–∏–Ω–∞–º–∏–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ª–µ—á–µ–Ω–∏—è")
    df = pd.DataFrame({
        "–ú–µ—Å—è—Ü": ["–Ø–Ω–≤", "–§–µ–≤", "–ú–∞—Ä", "–ê–ø—Ä"],
        "–ü—Ä–æ—Ü–µ–Ω—Ç —É–ª—É—á—à–µ–Ω–∏–π": [75, 78, 82, 80],
        "–ü–ª–∞–Ω–æ–≤—ã–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å": [80, 80, 80, 80]
    })
    fig = px.line(df, x="–ú–µ—Å—è—Ü", y=["–ü—Ä–æ—Ü–µ–Ω—Ç —É–ª—É—á—à–µ–Ω–∏–π", "–ü–ª–∞–Ω–æ–≤—ã–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å"],
                  title="–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø–ª–∞–Ω–æ–º")
    st.plotly_chart(fig, use_container_width=True)

    st.subheader("–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏—Å—Ö–æ–¥–æ–≤")
    outcomes = pd.DataFrame({
        "–ò—Å—Ö–æ–¥": ["–í—ã–∑–¥–æ—Ä–æ–≤–ª–µ–Ω–∏–µ", "–£–ª—É—á—à–µ–Ω–∏–µ", "–ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π", "–£—Ö—É–¥—à–µ–Ω–∏–µ"],
        "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ": [45, 30, 15, 10]
    })
    fig = px.pie(outcomes, names="–ò—Å—Ö–æ–¥", values="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ", title="–ò—Å—Ö–æ–¥—ã –ª–µ—á–µ–Ω–∏—è")
    st.plotly_chart(fig, use_container_width=True)

#api.py

from fastapi import FastAPI, HTTPException, Depends, Response, Request
from datetime import datetime
import random
from sqlalchemy.orm import Session
from authx import AuthX, AuthXConfig
from authx.schema import TokenPayload
from pydantic import BaseModel, Field, EmailStr, validator
from db_app.sqlalchemy_utils.database import get_db # type: ignore
from db_app.sqlalchemy_utils.models import UsersTable, PatientsTable, ResearchTable, PulseMonitoringTable, UsersComplainsTable #type:ignore


class AuthModel(BaseModel):
    mail: EmailStr
    password: str

class RegisterModel(AuthModel):
    Name: str

class PulseMonitoringInput(BaseModel):
    value: int
    patient_id: int|None = None  # –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è ID —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    
    #–í–∞–ª–∏–¥–∞—Ç–æ—Ä –Ω–∞ –≤—Å—è–∫–∏–π –æ—Å—Ç–∞–≤–∏–ª, –º–± –ø—Ä–∏–≥–æ–¥–∏—Ç—Å—è
    @validator('value')
    def validate_value(cls, v):
        if v <= 0:
            raise ValueError('–ó–Ω–∞—á–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º')
        if v > 300:
            raise ValueError('–ó–Ω–∞—á–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –≤–µ–ª–∏–∫–æ')
        return v
    
class ComplainDescription(BaseModel):
    PatientId: int
    Description: str

class Notification(BaseModel):
    message: str
    priority: str = "low"
    action_required: bool = True

app = FastAPI()

config = AuthXConfig()
config.JWT_SECRET_KEY = "SECRET_KEY"
config.JWT_ACCESS_COOKIE_NAME = "my_token"
config.JWT_TOKEN_LOCATION = ["headers","cookies"]
config.JWT_COOKIE_CSRF_PROTECT = False


security = AuthX(config=config)


def admin_required(db:Session = Depends(get_db), user_id: TokenPayload = Depends(security.access_token_required)):
    user = db.query(UsersTable).filter(
        UsersTable.Id == int(user_id.sub)
    ).first()

    if not user or user.RoleId != 2:
        raise HTTPException(
            status_code=403,
            detail="–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω"
        )

    return user

def get_patient(db: Session = Depends(get_db), patient_id:int=-1):
    patient = db.query(PatientsTable).filter(
            PatientsTable.Id == patient_id
        ).first()
    return patient
            

@app.post("/register")
def register_user(user: RegisterModel, response: Response, db: Session = Depends(get_db)):
    existing_user = db.query(UsersTable).filter(UsersTable.email == user.mail).first()
    if existing_user:
        raise HTTPException(
            status_code=400,
            detail="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
        )
    new_user = UsersTable(
        email=user.mail,
        Name=user.Name,
        password=user.password
    )
    try:
        db.add(new_user)
        db.commit()
        db.refresh(new_user)
    except Exception as e:
        db.rollback()
        return e

@app.post("/login")
def login(creds: AuthModel, response: Response, db: Session = Depends(get_db)):
    user = db.query(UsersTable).filter(UsersTable.email == creds.mail).first()
    
    if not user:
        raise HTTPException(status_code=404,detail="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω")

    if user.password != creds.password:
        raise HTTPException(status_code=401,detail="–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å")

    token = security.create_access_token(uid=str(user.Id), )
    refresh_token = security.create_refresh_token(uid=str(user.Id))
    security.set_access_cookies(token,response)
    security.set_refresh_cookies(refresh_token,response)

    return {"access_token": token,
            "refresh_token": refresh_token}
    
    
@app.get("/protected", dependencies=[Depends(security.access_token_required)])
def protected():
    return {"data": "SECRET"}

@app.get("/admin_protected", dependencies=[Depends(security.access_token_required)])
def admin_protected(user: UsersTable = Depends(admin_required)):
    
    return {"data": "SECRET FOR ADMINS"}

@app.get("/me")
def me(user_id: TokenPayload = Depends(security.access_token_required),db: Session = Depends(get_db)):

    u = db.query(UsersTable).filter(UsersTable.Id == int(user_id.sub)).first()

    return {
        "user_id": u.Id,
        "patient_id": u.PatientId,
        "role": u.RoleId,
        "name": u.Name
    }

@app.post("/refresh", dependencies=[Depends(security.refresh_token_required)])
def refresh_tokens(response: Response, user_id: TokenPayload = Depends(security.refresh_token_required)):
    new_access_token = security.create_access_token(uid=user_id.sub)
    security.set_access_cookies(new_access_token, response)

    return {"access_token": new_access_token}

@app.post("/logout")
def logout(response: Response):
    security.unset_access_cookies(response)
    security.unset_refresh_cookies(response)
    return {"message": "–í—ã—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ"}

@app.get("/patients", dependencies=[Depends(security.access_token_required)])
def get_all_patients(db: Session = Depends(get_db)):
    patients = db.query(PatientsTable).all()
    return {
        "total": len(patients),
        "patients": [
            {
                "id": p.Id,
                "first_name": p.FirstName,
                "second_name": p.SecondName,
                "patronomyc": p.Patronomyc,
                "age": p.Age,
                "snils": p.SNILS,
                "polis": p.POLIS,
                "tags": getattr(p, "Tags", "")  # –µ—Å–ª–∏ –ø–æ–ª–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –≤–µ—Ä–Ω—ë—Ç –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
            } for p in patients
        ]
    }

@app.patch("/patients/{patient_id}/tags", dependencies=[Depends(security.access_token_required), Depends(admin_required)])
def update_patient_tags(patient_id: int, tag: str, db: Session = Depends(get_db)):
    patient = db.query(PatientsTable).filter(PatientsTable.Id == patient_id).first()
    if not patient:
        raise HTTPException(404, "Patient not found")
    patient.Tags = tag
    db.commit()
    return {"message": "Tag updated"}

@app.post("/patients/bulk/tags", dependencies=[Depends(security.access_token_required), Depends(admin_required)])
def bulk_update_tags(data: dict, db: Session = Depends(get_db)):
    patient_ids = data.get("patient_ids", [])
    tag = data.get("tag", "")
    patients = db.query(PatientsTable).filter(PatientsTable.Id.in_(patient_ids)).all()
    for p in patients:
        p.Tags = tag
    db.commit()
    return {"message": f"Tag '{tag}' applied to {len(patients)} patients"}

@app.get("/journal", dependencies=[Depends(security.access_token_required)])
def get_journal(db: Session = Depends(get_db)):
    # –ó–∞–≥–ª—É—à–∫–∞ ‚Äì –º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ç–∞–±–ª–∏—Ü
    return [
        {"id": 1, "date": "2026-02-14", "type": "–ü—Ä–∏–µ–º", "description": "–û—Å–º–æ—Ç—Ä —Ç–µ—Ä–∞–ø–µ–≤—Ç–∞", "patient_id": 1, "patient_name": "–ò–≤–∞–Ω–æ–≤ –ò.–ò."},
        {"id": 2, "date": "2026-02-13", "type": "–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ", "description": "–ê–Ω–∞–ª–∏–∑ –∫—Ä–æ–≤–∏", "patient_id": 2, "patient_name": "–ü–µ—Ç—Ä–æ–≤ –ü.–ü."},
    ]

@app.post("/journal", dependencies=[Depends(security.access_token_required)])
def create_journal_entry(entry: dict, db: Session = Depends(get_db)):
    # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –≤ —Ä–µ–∞–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É, –Ω–æ –ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –∑–∞–≥–ª—É—à–∫–∞
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ñ–∏–∫—Ç–∏–≤–Ω—ã–π ID –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–∞–ø–∏—Å—å
    entry["id"] = random.randint(1000, 9999)
    # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—É—é –º–µ—Ç–∫—É —Å–æ–∑–¥–∞–Ω–∏—è
    entry["created_at"] = datetime.now().isoformat()
    return entry

@app.get("/recommendations", dependencies=[Depends(security.access_token_required)])
def get_recommendations(diagnosis: str = None):
    recs = {
        "–≥–∏–ø–µ—Ä—Ç–æ–Ω–∏—è": ["–ü—Ä–æ—Ç–æ–∫–æ–ª –ª–µ—á–µ–Ω–∏—è –≥–∏–ø–µ—Ä—Ç–æ–Ω–∏–∏ 2025", "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –¥–∏–µ—Ç–µ"],
        "–¥–∏–∞–±–µ—Ç": ["–°—Ç–∞–Ω–¥–∞—Ä—Ç—ã –ª–µ—á–µ–Ω–∏—è –°–î 2 —Ç–∏–ø–∞", "–ö–æ–Ω—Ç—Ä–æ–ª—å –≥–ª—é–∫–æ–∑—ã"],
        "–∏–±—Å": ["–í–µ–¥–µ–Ω–∏–µ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤ —Å –ò–ë–°", "–ê–Ω—Ç–∏–∞–≥—Ä–µ–≥–∞–Ω—Ç–Ω–∞—è —Ç–µ—Ä–∞–ø–∏—è"]
    }
    if diagnosis and diagnosis.lower() in recs:
        return recs[diagnosis.lower()]
    return recs

@app.get("/drug-interaction")
def check_drug_interaction(drug1: str, drug2: str):
    interactions = {
        ("–ê—Å–ø–∏—Ä–∏–Ω", "–í–∞—Ä—Ñ–∞—Ä–∏–Ω"): "–ü–æ–≤—ã—à–µ–Ω–Ω—ã–π —Ä–∏—Å–∫ –∫—Ä–æ–≤–æ—Ç–µ—á–µ–Ω–∏–π",
        ("–í–∞—Ä—Ñ–∞—Ä–∏–Ω", "–ê—Å–ø–∏—Ä–∏–Ω"): "–ü–æ–≤—ã—à–µ–Ω–Ω—ã–π —Ä–∏—Å–∫ –∫—Ä–æ–≤–æ—Ç–µ—á–µ–Ω–∏–π",
    }
    key = (drug1, drug2)
    if key in interactions:
        return {"interaction": interactions[key], "severity": "high"}
    return {"interaction": None, "severity": "none"}

@app.get("/medical-card", dependencies=[Depends(security.access_token_required)])
def get_medical_card(
    patient_id: int | None = None,
    db: Session = Depends(get_db)
):
    try:
        
        # –ù–∞—Ö–æ–¥–∏–º –ø–∞—Ü–∏–µ–Ω—Ç–∞
        patient: UsersTable = get_patient(db=db,patient_id=patient_id)
        
        if not patient:
            raise HTTPException(
                status_code=404,
                detail="–ü–∞—Ü–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"
            )
        
        # # –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–æ—Å–µ—â–µ–Ω–∏–π
        # visits = db.query(VisitsTable).filter(
        #     VisitsTable.PatientId == target_patient_id
        # ).order_by(VisitsTable.VisitDate.desc()).all()
        
        # # –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ –ª–µ—á–µ–Ω–∏—è
        # treatments = db.query(AssignedTreatmentTable).filter(
        #     AssignedTreatmentTable.PatientId == target_patient_id
        # ).order_by(AssignedTreatmentTable.TreatmentDate.desc()).all()
        
        # –ü–æ–ª—É—á–∞–µ–º –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è
        research = db.query(ResearchTable).filter(
            ResearchTable.PatientId == patient_id
        ).order_by(ResearchTable.EventDate.desc()).all()
        
        # –ü–æ–ª—É—á–∞–µ–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—É–ª—å—Å–∞
        pulse_monitoring = db.query(PulseMonitoringTable).filter(
            PulseMonitoringTable.PatientId == patient_id
        ).order_by(PulseMonitoringTable.CreatedAt.desc()).limit(30).all()
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
        medical_card = {
            "patient_info": {
                "id": patient.Id,
                "full_name": f"{patient.SecondName} {patient.FirstName} {patient.Patronomyc}",
                "age": patient.Age,
                "snils": patient.SNILS,
                "polis": patient.POLIS
            },
            # "visits_history": [
            #     {
            #         "id": visit.Id,
            #         "date": visit.VisitDate,
            #         "complain": visit.Complain,
            #         "symptoms": visit.Symptoms
            #     } for visit in visits
            # ],
            # "treatments": [
            #     {
            #         "id": treatment.Id,
            #         "date": treatment.TreatmentDate,
            #         "treatment_scheme": treatment.TreatmentScheme
            #     } for treatment in treatments
            # ],
            "research": [
                {
                    "id": r.Id,
                    "name": r.Name,
                    "date": r.EventDate,
                    "state": r.State,
                    "result": r.Result
                } for r in research
            ],
            "pulse_monitoring": [
                {
                    "id": pm.Id,
                    "date": pm.CreatedAt,
                    "value": pm.Value
                } for pm in pulse_monitoring
            ]
        }
        
        return medical_card
        
    except Exception as e:
        raise HTTPException(
            status_code=500,
            detail=f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–π –∫–∞—Ä—Ç—ã: {str(e)}"
        )
    

# –ö–†–ò–¢–ï–†–ò–ô 2: –ú–µ—Ç–æ–¥ –¥–ª—è –≤–≤–æ–¥–∞ –¥–∞–Ω–Ω—ã—Ö —Å–∞–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—è
@app.post("/pulse-monitoring", dependencies=[Depends(security.access_token_required)])
def add_pulse_monitoring(
    data: PulseMonitoringInput,
    db: Session = Depends(get_db)
):
    """
    –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å–∞–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—è –ø—É–ª—å—Å–∞.
    """
    try:
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º ID –ø–∞—Ü–∏–µ–Ω—Ç–∞
        patient_id = data.patient_id
        
        patient = get_patient(db,patient_id)
        
        if not patient:
            raise HTTPException(
                status_code=404,
                detail="–ü–∞—Ü–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"
            )
        
        pulse_record = PulseMonitoringTable(
            PatientId=patient_id,
            Value=data.value
        )
        
        db.add(pulse_record)
        db.commit()
        db.refresh(pulse_record)
        
        return {
            "message": "–î–∞–Ω–Ω—ã–µ —Å–∞–º–æ–∫–æ–Ω—Ç—Ä–æ–ª—è —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã",
            "record_id": pulse_record.Id,
            "patient_id": pulse_record.PatientId,
            "patient_name": patient.FirstName,
            "value": pulse_record.Value,
            "created_at": pulse_record.CreatedAt
        }
        
    except Exception as e:
        db.rollback()
        raise HTTPException(
            status_code=500,
            detail=f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö: {str(e)}")
    

@app.post("/sub_complains", dependencies=[Depends(security.access_token_required)])
def add_complains(
    data: ComplainDescription,
    db: Session = Depends(get_db),
    user_id: TokenPayload = Depends(security.access_token_required)):
    
    try:
        patient_id = data.PatientId
        
        patient = get_patient(db,patient_id)
        
        if not patient:
            raise HTTPException(
                status_code=404,
                detail="–ü–∞—Ü–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"
            )
        
        complain_record = UsersComplainsTable(
            PatientId=patient_id,
            Description=data.Description,
            UserId = int(user_id.sub)
        )
        
        db.add(complain_record)
        db.commit()
        db.refresh(complain_record)
        
        return {
            "message": "–ñ–∞–ª–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã",
            "record_id": complain_record.Id,
            "patient_id": complain_record.PatientId,
            "patient_name": patient.FirstName,
            "desc": complain_record.Description,
            "created_at": complain_record.CreatedAt
        }
        
    except Exception as e:
        db.rollback()
        raise HTTPException(
            status_code=500,
            detail=f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö: {str(e)}")
    
@app.get("/notifications", dependencies=[Depends(security.access_token_required), Depends(admin_required)])
def get_notifications(user_id: TokenPayload = Depends(security.access_token_required),
    db: Session = Depends(get_db)):
    user = db.query(UsersTable).filter(UsersTable.Id == int(user_id.sub)).first()
    notifications = []
    
    # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–∑–º–µ—Ä–µ–Ω–∏—è –ø—É–ª—å—Å–∞
    last_pulse = db.query(PulseMonitoringTable).filter(
        PulseMonitoringTable.PatientId == user.PatientId
    ).order_by(PulseMonitoringTable.CreatedAt.desc()).first()
    
    if last_pulse:
        # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –µ—Å–ª–∏ –¥–∞–≤–Ω–æ –Ω–µ –∏–∑–º–µ—Ä—è–ª–∏ –ø—É–ª—å—Å
        from datetime import datetime, timedelta
        if datetime.now() - last_pulse.CreatedAt > timedelta(hours=24):
            notifications.append(
                Notification(
                    message="–ü—Ä–æ—à–ª–æ –±–æ–ª–µ–µ 24 —á–∞—Å–æ–≤ —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–∑–º–µ—Ä–µ–Ω–∏—è –ø—É–ª—å—Å–∞",
                    priority="medium",
                    action_required=True
                )
            )
        
        # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –µ—Å–ª–∏ –ø—É–ª—å—Å –≤–Ω–µ –Ω–æ—Ä–º—ã
        if last_pulse.Value > 100:
            notifications.append(
                Notification(
                    message=f"–í—ã—Å–æ–∫–∏–π –ø—É–ª—å—Å ({last_pulse.Value} —É–¥/–º–∏–Ω). –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –æ—Ç–¥—ã—Ö",
                    priority="high",
                    action_required=True
                )
            )
        elif last_pulse.Value < 50:
            notifications.append(
                Notification(
                    message=f"–ù–∏–∑–∫–∏–π –ø—É–ª—å—Å ({last_pulse.Value} —É–¥/–º–∏–Ω)",
                    priority="medium",
                    action_required=True
                )
            )
            
    return {
        "user_id": user.Id,
        "total_notifications": len(notifications),
        "notifications": notifications
    }